<!DOCTYPE html>
<html>
<head>
  <title>Transform</title>
  <script src="bower_components/underscore/underscore.js"></script>
  <script>
    !function(context){
  
      context['data'] = [{
        timeframe: { 
          start: "2014-01-12T07:00:00.000Z", 
          end: "2014-01-19T07:00:00.000Z" 
        },
        value: [
          {
            page: 'home',
            result: {
              number: {
                value: 20
              }
            }
          },
          {
            page: 'contact',
            result: {
              number: {
                value: 14
              }
            }
          },
          {
            page: 'about',
            result: {
              number: {
                value: 5
              }
            }
          }
        ]
      },
      {
        timeframe: { 
          start: "2013-01-12T07:00:00.000Z", 
          end: "2013-01-19T07:00:00.000Z" 
        },
        value: [
          {
            page: 'home',
            result: {
              number: {
                value: 121
              }
            }
          },
          {
            page: 'contact',
            result: {
              number: {
                value: 543
              }
            }
          },
          {
            page: 'about',
            result: {
              number: {
                value: 1
              }
            }
          }
        ]
      }];
      
      
      function flatten(root, setup) {
        this.build(root, setup);
      }
      
      flatten.prototype.build = function(root, setup) {
        var self = this;
        self.cols = {
          index: setup.cols.index.split(" -> "),
          cells: setup.cols.cells.split(" -> ")
        };
        self.rows = {
          index: setup.rows.index.split(" -> "),
          cells: setup.rows.cells.split(" -> ")
        };
        self.table = [];
				self.series = [];
        self.raw = root;
        
        // Header (Series)
        (function(){
          var index = [self.cols.index];
          var cells = parse.apply(self, [root[0]].concat(self.cols.cells));
          self.table.push(index.concat(cells));
					_.each(cells, function(el, index){
						self.series.push({ title: el, value: [] });
					});
        })();
        
        // Rows
        _.each(root, function(el, i){
          var index = parse.apply(self, [el].concat(self.rows.index));
          var cells = parse.apply(self, [el].concat(self.rows.cells));
          self.table.push(index.concat(cells));
					_.each(self.series, function(series, j){
						series['value'].push(cells[j]);
					});
        });
        
        return this;
      };
			flatten.prototype.render = function(format){
				if (format == 'csv') {
					console.log(this.table.join('\n'));
				}
			};
      
      
      function parse() {
        var result = [];
        var loop = function() {
          var root = arguments[0];
          var args = Array.prototype.slice.call(arguments, 1);
          var target = args.pop();
          //console.log('DIVE ' + target + ':', root, args);
          
          if (args.length == 0 && root instanceof Array) {
            args = root;
          }
          
          _.each(args, function(el, index, list){
            
            if (el[target] || el[target] == 0) {
              // Easy grab!
              return result.push(el[target]);
              
            } else if (root[el]){
              
              if (root[el] instanceof Array) {
                // dive through each array item
                _.each(root[el], function(n, i) {
                  var splinter = [root[el]].concat(root[el][i]).concat(args.slice(1)).concat(target);
                  return loop.apply(this, splinter);
                });
                
              } else {
                if (root[el][target]) {
                  // grab it!
                  return result.push(root[el][target]);
                  
                } else {
                  // dive down a level!
                  return loop.apply(this, [root[el]].concat(args.splice(1)).concat(target));
                  
                }
              }
              
            } else {
              // dive down a level!
              return loop.apply(this, [el].concat(args.splice(1)).concat(target));
              
            }
            
            return; 

          });
          if (result.length > 0) {
            return result;
          }
        }
        return loop.apply(this, arguments);
      }
      
      context['parsed'] = new flatten(context['data'], {
        cols: {
          index: '"interval"',
          cells: 'value -> page'
        },
        rows: {
          index: 'timeframe -> start',
          cells: 'value -> result -> number -> value'
        }
      });
      
      console.log('Raw', context['parsed'].raw);
      console.log('Table', context['parsed'].table);
			console.log('Series', context['parsed'].series);
      
   }(this);
  </script>
</head>
<body>
  
</body>
</html>